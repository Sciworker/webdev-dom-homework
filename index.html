<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        <!-- <li class="comment">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div>12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">3</span>
              <button class="like-button"></button>
            </div>
          </div>
        </li>
        <li class="comment">
          <div class="comment-header">
            <div>Варвара Н.</div>
            <div>13.02.22 19:22</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Мне нравится как оформлена эта страница! ❤
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">75</span>
              <button class="like-button -active-like"></button>
            </div>
          </div>
        </li> -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"
        ></textarea>
        <div class="add-form-response">
            
        </div>
        <div class="add-form-row">
          <button class="add-form-button" disabled>Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
    // Код писать здесь

    let comments = null;
    const API_URL = 'https://wedev-api.sky.pro/api/v1/:Petr/comments';
    // получаем элементы необходимые для работы (используем document.querySelector('.class-name')) - будет искать элемент на странице по названию класса
    // форма
    const form = document.querySelector(".add-form");
    // кнопка формы для добавления комментария
    const addCommentButton = form.querySelector('.add-form-button');
    // контейнер комментариев
    const commentsContainer = document.querySelector(".comments");

    // добавляем слушатель события на кнопку: при клике будет вызываться функция addComment (см далее)
    addCommentButton.addEventListener("click", addFormComment);

    fetchComments(API_URL);

    // асинхронная функция для выгрузки комментариев комментария
    async function fetchComments(url) {
      try {
        // выводим надпись "Загрузка..." чтобы пользователь видел что комментарии загружаются
        commentsContainer.innerHTML = "Загрузка...";
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();

        comments = data.comments;
        for (let comment of comments) {
          comment.date = formatDate(new Date(comment.date));
        }
        console.log(comments);
        renderComments(comments);
        // включаем кнопку добавления комментария когда комментарии успешно загрузились и отрисовались (изначально она выключена у тега button установлен аттрибут disabled)
        addCommentButton.disabled = false;
        console.log(comments);

      } catch(error) {
        // в случае ошибки выводим надпись 'Упс, возникла ошибка!'
        commentsContainer.innerHTML = 'Упс, возникла ошибка!';
        console.error('There was a problem with the fetch operation:', error);
      }
      console.log(comments);
    }

    function renderComments(comments) {
      commentsContainer.innerHTML = '';
      for (const comment of comments) {
        commentsContainer.append(createCommentElement(comment));
      }
    }
    
    function likeComment() {
      const targetCommentElement = event.target.closest(".comment");
      const comment = comments[Array.from(commentsContainer.children).indexOf(targetCommentElement)];
      // console.log(Array.from(commentsContainer.children).indexOf(targetCommentElement), targetCommentElement, appropriateComment);
      toggleLike(comment);
      renderComments(comments);
      // console.log(comments);
    }

    function toggleLike(comment) {
      comment.liked = !comment.liked;
      if (comment.liked) {
        comment.likes++;
      } else {
        comment.likes--;
      }
    }

    // функция для проверки значений формы, которая будет возвращать true если поля заполнены, иначе - false 
    function validateCommentData({author, text} = {}) {
      // функция принимает объект с полями author и text которые обозначают имя автора и текст соответсвенно
      // делаем trim() чтобы убрать пробелы в начале и в конце - таким образом если пользователь введет три пробела поле будет считаться пустым
      if (author.trim().length >= 3 && text.trim().length >= 3) {
        return true;
      }
      return false;
    }

    // функция для создания элемента комментария
    // так выглядит html код комментария
    // <li class="comment">
    //   <div class="comment-header">
    //     <div>Глеб Фокин</div>
    //     <div>12.02.22 12:18</div>
    //   </div>
    //   <div class="comment-body">
    //     <div class="comment-text">
    //       Это будет первый комментарий на этой странице
    //     </div>
    //   </div>
    //   <div class="comment-footer">
    //     <div class="likes">
    //       <span class="likes-counter">3</span>
    //       <button class="like-button"></button>
    //     </div>
    //   </div>
    // </li>
    function createCommentElement({author, text, date, likes = 0, liked = false} = {}) {
      // функция принимает объект с полями author text date и likes которые обозначают имя автора текст дата и количество лайков соответственно

      // создаем <li></li>
      const commentElement = document.createElement('li');
      // добавляем ему класс class="comment"
      commentElement.classList.add('comment');

      // вставляем внутрь структуру комментария
      commentElement.innerHTML = `
      <div class="comment-header">
          <div>${author.name || author}</div>
          <div>${date}</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">${text}
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">${likes}</span>
            <button class="like-button${liked ? ' -active-like' : ''}" onclick="likeComment()""></button>
          </div>
        </div>
        `;

      // возвращаем сконструированный html код комментария
      return commentElement;
    }

    // функция возвращающая строку даты в нужном формате
    function formatDate(date) {
      // получает объект даты создания комментария
      // каждый параметр даты дополняется 0 спереди если является однозначной цифрой
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      // возвращаем строку с датой в нужном формате
      return `${day}.${month}.${year} ${hours}:${minutes}`;
    }
    // // 2024-05-05T15:04:46.439Z
    // function formatDateAPI(date) {
    //   for(const comment of date) {
    //     let result = new Date(comment.date);
    //     let options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit',second:'2-digit'};
    //     let result1 = result.toLocaleDateString("ru-RU", options)
    //     comment.date =  result1
    //   }
    //   return date
    // }
    
    // функция добавления комментария
    function addFormComment() {
      // отключаем кнопку добавления комментария пока новый комментарий будет добавляться
      addCommentButton.disabled = true;
      // элемент для вывода сообщений пользователю
      const formResponse = document.querySelector(".add-form-response");
      formResponse.style.color = '';
      // получаем имя автора из поля ввода формы
      const author = form.querySelector(".add-form-name").value;
      // аналогично получаем текст комментария
      const text = form.querySelector(".add-form-text").value;
      // получаем строку с датой в нужно формате (передаем новосозданный объект Date)
      const date = formatDate(new Date());
      // создаем объект комментария с полями author text date и likes которые обозначают имя автора текст дата и количество лайков соответственно
      const comment = {author, text, date};

      if (validateCommentData(comment)) {
        // оповещаем пользователя о добавлении комментария
        formResponse.innerHTML = 'Добавление комментария...';
        // Данные нового комментария
        const newCommentData = {
          "text": comment.text,
          "name": comment.author,
        };
        console.log(JSON.stringify(newCommentData))

        // Опции для запроса
        const options = {
          method: 'POST',
          body: JSON.stringify(newCommentData) // Преобразуем данные нового комментария в JSON и передаем в тело запроса
        };
        // Отправляем POST-запрос
        fetch(API_URL, options)
          .then(response => {
            // Проверяем, успешен ли ответ
            if (!response.ok) {
              throw new Error('Ошибка сетевого запроса');
            }
            // Возвращаем ответ в формате JSON
            return response.json();
          })
          .then(data => {
            // Проверяем, получен ли объект результата
            if (data.result === 'ok') {
              // если поля не пустые (validateCommentData(comment) вернула true)
              // создаем элемент комментария
              const commentElement = createCommentElement(comment);
              // добавляем его в контейнер комментариев
              comments.push({author, text, date, likes: 0, liked: false});
              commentsContainer.append(commentElement);
              // стираем значения полей ввода формы 
              form.querySelector(".add-form-name").value = '';
              form.querySelector(".add-form-text").value = '';
              formResponse.style.color = 'green';
              formResponse.innerHTML = `Комментарий успешно добавлен`;
              // иначе выводим модальное окно с надписью "Не все поля заполнены!"
              console.log('Комментарий успешно добавлен:', data);
            } else {
              formResponse.style.color = 'red';
              formResponse.innerHTML = `Ошибка при добавлении комментария`;
              console.error('Ошибка при добавлении комментария:', data.error);
            }
          })
          .catch(error => {
            formResponse.style.color = 'red';
            formResponse.innerHTML = `Произошла ошибка с запросом`;
            // Обрабатываем любые ошибки, возникшие во время запроса
            console.error('Произошла ошибка с запросом:', error);
          })
          .finally(() => {
            // независимо от результата добавления запроса включаем кнопку добавления комментария
            addCommentButton.disabled = false;
          });

      } else {
        // если валидация полей не прошла - выводим причину
        formResponse.style.color = 'red';
        if (author.length < 3 && author.length !== 0 ) { 
          formResponse.innerHTML = `Мало символов в поле авторов`;
        } else if (text.length < 3 && text.length !== 0) {
          formResponse.innerHTML = `Мало символов в поле текст`;
        } else {
          formResponse.innerHTML = `Поля должны быть заполнены`;
        }
        // включаем кнопку добавления комментария
        addCommentButton.disabled = false;
      }
    }

    console.log("It works!");
  </script>
</html>